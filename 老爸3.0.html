<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>六年八班课堂积分乐园</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background-color: #f0f8ff; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #4a90e2; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #666; font-size: 1.2em; }
        .class-photo { width: 100%; max-height: 400px; object-fit: cover; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 20px 0; }
        .entry-buttons { text-align: center; margin: 30px 0; }
        .entry-buttons button { background-color: #4a90e2; color: white; border: none; padding: 15px 30px; font-size: 1.2em; border-radius: 10px; cursor: pointer; margin: 0 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: background-color 0.3s; }
        .entry-buttons button:hover { background-color: #357abd; }
        .teacher-view, .student-view { display: none; }
        .week-selector { text-align: center; margin: 20px 0; font-size: 1.2em; }
        .week-selector select { padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; background-color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #4a90e2; color: white; font-weight: bold; }
        .name-cell { text-align: left; padding-left: 20px; font-weight: bold; }
        .daily-score { font-size: 0.8em; color: #666; margin-top: 2px; display: flex; justify-content: space-around; }
        .daily-score div { width: 20%; text-align: center; }
        .total { font-weight: bold; color: #4a90e2; }
        .score-input { width: 60px; padding: 5px; margin: 0 auto; border: 2px solid #ddd; border-radius: 5px; text-align: center; font-size: 1em; }
        .score-input:focus { border-color: #4a90e2; outline: none; }
        .actions { text-align: center; margin: 20px 0; }
        .actions button { background-color: #f0ad4e; color: white; border: none; padding: 10px 20px; margin: 0 10px; border-radius: 5px; cursor: pointer; font-size: 1em; }
        .back-btn { display: block; width: 120px; margin: 20px auto; background-color: #6c757d; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; text-align: center; }
        .student-form, .rankings { text-align: center; margin: 50px 0; }
        .student-form input { padding: 10px; width: 200px; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; margin-right: 10px; }
        .student-form button { background-color: #4a90e2; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .student-result { background-color: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 800px; margin: 30px auto; }
        .student-result h2, .rankings h2 { color: #4a90e2; margin-bottom: 20px; text-align: center; }
        .result-item, .rank-item { margin: 15px 0; font-size: 1.2em; }
        .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px dashed #eee; }
        .rank-item:first-child { background-color: #fff4e6; }
        .rank-item:nth-child(2) { background-color: #f0f8ff; }
        .rank-item:nth-child(3) { background-color: #fff8e1; }
        .rank-icon { font-size: 1.5em; }
        .progress-star { background-color: #ffeb3b; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>六年八班课堂积分乐园</h1>
            <p>记录成长，快乐学习</p>
        </div>

        <img src="class.jpg" alt="六年八班全家福" class="class-photo">
        
        <div class="entry-buttons" id="homeButtons">
            <button onclick="loginAsTeacher()">我是老师 👩‍🏫</button>
            <button onclick="showStudentView()">我是学生 🧒</button>
        </div>

        <!-- 老师视图 -->
        <div id="teacherView" class="teacher-view">
            <h2 style="text-align:center;">六（8）班语文课堂积分表</h2>
            <div class="week-selector">
                <label for="weekSelect">第 </label>
                <select id="weekSelect">
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                    <option>5</option><option>6</option><option>7</option><option>8</option>
                    <option>9</option><option>10</option>
                </select>
                <label for="weekSelect"> 周</label>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>序号</th><th>姓名</th><th>周一</th><th>周二</th><th>周三</th><th>周四</th><th>周五</th><th>总分</th>
                        <th>序号</th><th>姓名</th><th>周一</th><th>周二</th><th>周三</th><th>周四</th><th>周五</th><th>总分</th>
                    </tr>
                </thead>
                <tbody id="teacherTableBody">
                </tbody>
            </table>

            <div class="actions">
                <button onclick="saveAndExit()">保存并退出</button>
                <button onclick="clearWeekData()">清空本周数据</button>
                <button onclick="goBackToHome()">返回首页</button>
                <button onclick="logout()" style="background-color: #d9534f;">退出登录</button>
                <button onclick="openChangePassword()" style="background-color: #5cb85c;">修改密码</button>
                <button onclick="finishWeek()" style="background-color: #9c27b0;">结束本周</button>
            </div>
            <p style="text-align:center; color:#999; font-size:0.9em; margin-top:10px;">
                🔐 温馨提示：请老师离开前点击【退出登录】以保护数据安全。
            </p>
        </div>

        <!-- 学生查看页 -->
        <div id="studentView" class="student-view">
            <div class="student-form">
                <h2>查看我的积分</h2>
                <input type="text" id="studentName" placeholder="请输入您的姓名">
                <button onclick="checkStudent()">查询</button>
            </div>

            <div class="student-result" id="studentResult" style="display:none;">
                <h2>欢迎，<span id="resultName"></span>！🌟</h2>
                <div class="result-item">您本周的积分是：<span id="resultScore">0</span> 分</div>
                <div class="result-item">您在班级中的排名是第 <span id="resultRank">1</span> 名</div>
                <div class="result-item" id="resultReward"></div>
                <div class="result-item"><span id="resultProgress"></span></div>

                <div class="rankings">
                    <h2>🌟 本周进步之星</h2>
                    <div id="progressList"></div>
                </div>

                <div class="rankings">
                    <h2>🏆 本周积分前十名</h2>
                    <div id="top10List"></div>
                </div>

                <button class="back-btn" onclick="goBackToHome()">返回首页</button>
            </div>
        </div>
    </div>

    <!-- 调试按钮（可选） -->
    <button onclick="debugData()" style="position:fixed;bottom:10px;right:10px;background:#333;color:#fff;padding:5px 10px;font-size:12px;z-index:999;">[调试] 查看数据</button>

    <script>
        // ================== 🔐 密码管理 ==================
        let ENCODED_PASSWORD = 'MTIzNDU2'; // '123456' 的 Base64 编码

        window.onload = function() {
            console.log('🚀 页面加载中...');

            const savedPassword = localStorage.getItem('class8Password');
            if (savedPassword) {
                ENCODED_PASSWORD = savedPassword;
                console.log('🔐 密码已从 localStorage 加载');
            }

            const saved = localStorage.getItem('class8Students');
            if (saved) {
                try {
                    students = JSON.parse(saved);
                    console.log(`✅ 成功加载 ${students.length} 名学生数据`);
                } catch (e) {
                    console.error('❌ 数据解析失败，使用初始名单', e);
                    students = JSON.parse(JSON.stringify(initialStudents));
                }
            } else {
                console.log('🟡 未找到本地数据，使用初始名单');
                students = JSON.parse(JSON.stringify(initialStudents));
            }

            isTeacherLoggedIn = false;
            generateTeacherTable();
            updateAllTotals();
        };

        function getRealPassword() {
            try {
                return atob(ENCODED_PASSWORD);
            } catch (e) {
                alert('密码解码失败，请联系管理员。');
                return '';
            }
        }

        function setNewPassword(newPwd) {
            ENCODED_PASSWORD = btoa(newPwd);
            localStorage.setItem('class8Password', ENCODED_PASSWORD);
        }

        // ================== 学生数据（已清理空格）==================
        const initialStudents = [
            { id: 1, name: "卢淳雅", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 50 },
            { id: 2, name: "黄筱晴", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 70 },
            { id: 3, name: "李恩可", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 65 },
            { id: 4, name: "赵元圆", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 60 },
            { id: 5, name: "周诗霖", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 55 },
            { id: 6, name: "林梓烁", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 40 },
            { id: 7, name: "孙晨熙", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 30 },
            { id: 8, name: "陈正霖", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 50 },
            { id: 9, name: "叶展新", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 45 },
            { id: 10, name: "孙泽钰", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 40 },
            { id: 11, name: "汤媛", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 50 },
            { id: 12, name: "陈可歆", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 35 },
            { id: 13, name: "王圣漪", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 48 },
            { id: 14, name: "陈梓宏", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 55 },
            { id: 15, name: "林雨墕", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 50 },
            { id: 16, name: "齐修远", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 58 },
            { id: 17, name: "王曾懿", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 42 },
            { id: 18, name: "连柏衡", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 45 },
            { id: 19, name: "高希", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 48 },
            { id: 20, name: "郭和盛", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 40 },
            { id: 21, name: "朱铭轩", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 38 },
            { id: 22, name: "施妍昕", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 52 },
            { id: 23, name: "陈纪弥", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 45 },
            { id: 24, name: "王靖萱", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 50 },
            { id: 25, name: "许婉琳", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 45 },
            { id: 26, name: "龚卓玮", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 50 },
            { id: 27, name: "王胤祥", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 55 },
            { id: 28, name: "吴锦霖", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 48 },
            { id: 29, name: "任智翔", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 40 },
            { id: 30, name: "张莫然", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 50 },
            { id: 31, name: "欧阳鑫怡", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 55 },
            { id: 32, name: "张雅馨", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 58 },
            { id: 33, name: "曾琪淑", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 50 },
            { id: 34, name: "孙可馨", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 45 },
            { id: 35, name: "卢欣怡", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 40 },
            { id: 36, name: "王子睿", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 50 },
            { id: 37, name: "肖博恒", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 55 },
            { id: 38, name: "洪子钦", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 48 },
            { id: 39, name: "黄恬欣", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 52 },
            { id: 40, name: "胡佳俊", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 35 },
            { id: 41, name: "孙杰铭", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 40 },
            { id: 42, name: "吴泽楷", scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }, total: 0, lastWeek: 30 }
        ];

        let students = [];
        let isTeacherLoggedIn = false;

        // ================== 数据操作 ==================
        function saveData() {
            try {
                localStorage.setItem('class8Students', JSON.stringify(students));
                console.log('💾 数据已保存');
            } catch (e) {
                console.error('❌ 保存失败', e);
                alert('数据保存失败！请检查是否在无痕模式');
            }
        }

        window.addEventListener('beforeunload', () => {
            if (isTeacherLoggedIn) saveData();
        });

        function saveAndExit() {
            saveData();
            alert('数据已保存！');
            goBackToHome();
        }

        function clearWeekData() {
            if (confirm('确定要清空本周所有数据吗？')) {
                students.forEach(s => {
                    s.scores.mon = 0; s.scores.tue = 0; s.scores.wed = 0;
                    s.scores.thu = 0; s.scores.fri = 0; s.total = 0;
                });
                updateAllTotals();
                saveData();
            }
        }

        function finishWeek() {
            if (confirm('结束本周？将当前总分设为下周“上周积分”？')) {
                students.forEach(s => s.lastWeek = s.total);
                saveData();
                alert('已更新上周积分！');
            }
        }

        // ================== 登录 ==================
        function loginAsTeacher() {
            const pwd = prompt('请输入老师密码 🔐');
            if (!pwd) return;
            if (pwd === getRealPassword()) {
                isTeacherLoggedIn = true;
                sessionStorage.setItem('teacherLoggedIn', 'true');
                showTeacherView();
            } else {
                alert('密码错误！');
            }
        }

        function showTeacherView() {
            if (sessionStorage.getItem('teacherLoggedIn') !== 'true') {
                loginAsTeacher();
                return;
            }
            document.getElementById('homeButtons').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.class-photo').style.display = 'none';
            document.getElementById('teacherView').style.display = 'block';
        }

        function showStudentView() {
            document.getElementById('homeButtons').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.class-photo').style.display = 'none';
            document.getElementById('studentView').style.display = 'block';
        }

        function goBackToHome() {
            document.getElementById('teacherView').style.display = 'none';
            document.getElementById('studentView').style.display = 'none';
            document.getElementById('homeButtons').style.display = 'block';
            document.querySelector('.header').style.display = 'block';
            document.querySelector('.class-photo').style.display = 'block';
        }

        function logout() {
            sessionStorage.removeItem('teacherLoggedIn');
            isTeacherLoggedIn = false;
            alert('已安全退出登录');
            goBackToHome();
        }

        function openChangePassword() {
            const oldPwd = prompt('请输入当前密码：');
            if (oldPwd !== getRealPassword()) {
                alert('原密码错误！');
                return;
            }
            const newPwd = prompt('请输入新密码：');
            if (!newPwd || newPwd !== prompt('请再次输入：')) {
                alert('密码为空或不一致！');
                return;
            }
            setNewPassword(newPwd);
            alert('✅ 密码已更新！');
        }

        // ================== 表格 ==================
        function generateTeacherTable() {
            const tbody = document.getElementById('teacherTableBody');
            let html = '';
            for (let i = 0; i < 21; i++) {
                const left = students[i];
                const right = students[i + 21] || { id: '', name: '', scores: { mon:0,tue:0,wed:0,thu:0,fri:0 }, total: 0 };
                html += `
                <tr>
                    <td>${left.id}</td>
                    <td class="name-cell">${left.name}
                        <div class="daily-score">
                            <div>周一:${left.scores.mon}</div>
                            <div>周二:${left.scores.tue}</div>
                            <div>周三:${left.scores.wed}</div>
                            <div>周四:${left.scores.thu}</div>
                            <div>周五:${left.scores.fri}</div>
                        </div>
                    </td>
                    <td><input type="number" class="score-input" onkeydown="if(event.key==='Enter'){updateScore(${left.id},'mon',+this.value||0);this.value='';}"></td>
                    <td><input type="number" class="score-input" onkeydown="if(event.key==='Enter'){updateScore(${left.id},'tue',+this.value||0);this.value='';}"></td>
                    <td><input type="number" class="score-input" onkeydown="if(event.key==='Enter'){updateScore(${left.id},'wed',+this.value||0);this.value='';}"></td>
                    <td><input type="number" class="score-input" onkeydown="if(event.key==='Enter'){updateScore(${left.id},'thu',+this.value||0);this.value='';}"></td>
                    <td><input type="number" class="score-input" onkeydown="if(event.key==='Enter'){updateScore(${left.id},'fri',+this.value||0);this.value='';}"></td>
                    <td class="total" id="total-${left.id}">${left.total}</td>
                    
                    <td>${right.id}</td>
                    <td class="name-cell">${right.name}
                        <div class="daily-score">
                            <div>周一:${right.scores.mon}</div>
                            <div>周二:${right.scores.tue}</div>
                            <div>周三:${right.scores.wed}</div>
                            <div>周四:${right.scores.thu}</div>
                            <div>周五:${right.scores.fri}</div>
                        </div>
                    </td>
                    <td><input type="number" class="score-input" onkeydown="if(event.key==='Enter'){updateScore(${right.id},'mon',+this.value||0);this.value='';}"></td>
                    <td><input type="number" class="score-input" onkeydown="if(event.key==='Enter'){updateScore(${right.id},'tue',+this.value||0);this.value='';}"></td>
                    <td><input type="number" class="score-input" onkeydown="if(event.key==='Enter'){updateScore(${right.id},'wed',+this.value||0);this.value='';}"></td>
                    <td><input type="number" class="score-input" onkeydown="if(event.key==='Enter'){updateScore(${right.id},'thu',+this.value||0);this.value='';}"></td>
                    <td><input type="number" class="score-input" onkeydown="if(event.key==='Enter'){updateScore(${right.id},'fri',+this.value||0);this.value='';}"></td>
                    <td class="total" id="total-${right.id}">${right.total}</td>
                </tr>`;
            }
            tbody.innerHTML = html;
        }

        function updateScore(id, day, points) {
            if (points === 0) return;
            const student = students.find(s => s.id === id);
            if (student) {
                student.scores[day] += points;
                student.total = Object.values(student.scores).reduce((a,b)=>a+b,0);
                document.getElementById(`total-${id}`).textContent = student.total;
            }
            saveData();
        }

        function updateAllTotals() {
            students.forEach(s => {
                s.total = Object.values(s.scores).reduce((a,b)=>a+b,0);
                const el = document.getElementById(`total-${s.id}`);
                if (el) el.textContent = s.total;
            });
        }

        // ================== 学生查询 ==================
        function checkStudent() {
            const name = document.getElementById('studentName').value.trim();
            if (!name) return alert('请输入姓名');

            const cleanInput = name.replace(/\s+/g, '');
            const student = students.find(s => s.name.replace(/\s+/g, '') === cleanInput);

            if (!student) return alert('未找到该学生');

            document.getElementById('resultName').textContent = student.name;
            document.getElementById('resultScore').textContent = student.total;

            const rank = [...students].sort((a,b)=>b.total-a.total).findIndex(s=>s.id===student.id)+1;
            document.getElementById('resultRank').textContent = rank;

            const reward = document.getElementById('resultReward');
            reward.innerHTML = student.total >= 30 
                ? `🎉 可抵扣 <strong>${Math.floor(student.total/30)} 项</strong> 作业！`
                : `💪 加油，满30分可抵扣作业！`;

            const progress = student.total - student.lastWeek;
            document.getElementById('resultProgress').innerHTML = 
                progress > 0 ? `📈 进步 <strong>+${progress}分</strong>！` :
                progress < 0 ? `📉 退步 <strong>${-progress}分</strong>` :
                `📊 保持稳定`;

            updateRankings();
            document.getElementById('studentResult').style.display = 'block';
        }

        function updateRankings() {
            const top10 = [...students].sort((a,b)=>b.total-a.total).slice(0,10);
            document.getElementById('top10List').innerHTML = top10.map((s,i)=>
                `<div class="rank-item"><span>${i+1}</span><span>${s.name}</span><span>${s.total}分</span></div>`
            ).join('');

            const progress = students.map(s=>({n:s.name,p:s.total-s.lastWeek})).filter(s=>s.p>0).sort((a,b)=>b.p-a.p).slice(0,3);
            document.getElementById('progressList').innerHTML = progress.length
                ? progress.map(s=>`<div class="rank-item">⭐ <span>${s.n}</span> <span>+${s.p}分</span></div>`).join('')
                : '<div class="rank-item">暂无进步同学</div>';
        }

        // ================== 调试 ==================
        function debugData() {
            const saved = localStorage.getItem('class8Students');
            alert(`本地数据: ${!!saved}\n学生数: ${saved ? JSON.parse(saved).length : 0}`);
        }
    </script>
</body>
</html>